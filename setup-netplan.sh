#!/bin/bash

# ==============================================================================
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐµÑ‚Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Netplan Ð² Ubuntu (v4)
# - ÐÐ²Ñ‚Ð¾-Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… IP Ð² ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
# - ÐÐ²Ñ‚Ð¾-Ð¿Ð¾Ð´ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¼Ð°ÑÐ¾Ðº (/24, /64, /16)
# - Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº DNS-ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²
# - ÐÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ 'routes' Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° 600
# ==============================================================================

# --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· pipe
if ! [ -t 0 ]; then
    echo "ðŸš« ÐžÑˆÐ¸Ð±ÐºÐ°: Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð¸ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· pipe."
    echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: sudo bash -c \"\$(curl -sSL [URL])\""
    exit 1
fi

# --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
if [[ $EUID -ne 0 ]]; then
   echo "ðŸš« ÐžÑˆÐ¸Ð±ÐºÐ°: Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (sudo)."
   exit 1
fi

# --- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
validate_ip() {
    local ip=$1
    # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ð¿Ð¾Ñ…Ð¾Ð¶Ðµ Ð½Ð° IP
    if [[ $ip =~ ^[0-9]{1,3}\. ]]; then return 0; else return 1; fi
}

validate_ipv6() {
    local ip=$1
    if [[ $ip == *":"* ]]; then return 0; else return 1; fi
}

clear
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑƒÐ¼Ð½ÑƒÑŽ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ ÑÐµÑ‚Ð¸ Netplan (v4)..."
echo "--------------------------------------------------------"
echo "ðŸ’¡ Ð¡Ð¾Ð²ÐµÑ‚: ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ."

# --- ÐÐ²Ñ‚Ð¾-Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº ---
current_ipv4_ens3=$(ip -4 addr show ens3 | grep -oP 'inet \K[\d.\/]+' | head -n 1)
current_ipv6_ens3=$(ip -6 addr show ens3 | grep -oP 'inet6 \K[0-9a-fA-F:\/]+' | grep -v '^fe80' | head -n 1)
current_ipv4_ens6=$(ip -4 addr show ens6 | grep -oP 'inet \K[\d.\/]+' | head -n 1)

# --- Ð‘Ð»Ð¾Ðº Ð²Ð²Ð¾Ð´Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ---

# 1. IPv4 Ð´Ð»Ñ ens3
read -e -p "1ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ IPv4 Ð´Ð»Ñ ens3: " -i "$current_ipv4_ens3" ipv4_ens3
if [[ -n "$ipv4_ens3" && ! "$ipv4_ens3" == *"/"* ]]; then
    ipv4_ens3="$ipv4_ens3/24"
    echo "   -- ÐœÐ°ÑÐºÐ° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° /24 --> $ipv4_ens3"
fi

# 2. Ð¨Ð»ÑŽÐ· Ð´Ð»Ñ IPv4
ip_part=$(echo $ipv4_ens3 | cut -d'/' -f1)
suggested_gateway=$(echo $ip_part | awk -F. '{print $1"."$2"."$3".1"}')
read -e -p "2ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ IPv4 ÑˆÐ»ÑŽÐ·: " -i "$suggested_gateway" gateway4

# 3. IPv6 Ð´Ð»Ñ ens3 (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
read -e -p "3ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ IPv6 Ð´Ð»Ñ ens3 (Enter Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°): " -i "$current_ipv6_ens3" ipv6_ens3
if [[ -n "$ipv6_ens3" && ! "$ipv6_ens3" == *"/"* ]]; then
    ipv6_ens3="$ipv6_ens3/64"
    echo "   -- ÐœÐ°ÑÐºÐ° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° /64 --> $ipv6_ens3"
fi
gateway6="fe80::1" # Ð¨Ð»ÑŽÐ· Ð´Ð»Ñ IPv6 Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ð²ÑÐµÐ³Ð´Ð° link-local

# 4. Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ IP Ð´Ð»Ñ ens6
read -e -p "4ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ IP Ð´Ð»Ñ ens6: " -i "$current_ipv4_ens6" ipv4_ens6
if [[ -n "$ipv4_ens6" && ! "$ipv4_ens6" == *"/"* ]]; then
    ipv4_ens6="$ipv4_ens6/16"
    echo "   -- ÐœÐ°ÑÐºÐ° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°, Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° /16 --> $ipv4_ens6"
fi

echo "--------------------------------------------------------"
echo "âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ñ‹. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."

# --- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Netplan ---
cat > /etc/netplan/01-netcfg.yaml << EOF
# Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð±Ñ‹Ð» ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð¼
network:
  version: 2
  renderer: networkd
  ethernets:
    ens3:
      addresses:
        - "$ipv4_ens3"
$( [ -n "$ipv6_ens3" ] && echo "        - \"$ipv6_ens3\"" )
      routes:
        - to: default
          via: $gateway4
$( [ -n "$ipv6_ens3" ] && echo "        - to: default
          via: $gateway6" )
      nameservers:
          addresses:
              - "8.8.8.8"
              - "1.1.1.1"
              - "8.8.4.4"
              - "1.0.0.1"
              - "2001:4860:4860::8888"
              - "2001:4860:4860::8844"
              - "2606:4700:4700::1111"
              - "2606:4700:4700::1001"
$( [ -n "$ipv4_ens6" ] && cat << EOL
    ens6:
      addresses:
        - "$ipv4_ens6"
EOL
)
EOF

# --- Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° ---
chmod 600 /etc/netplan/01-netcfg.yaml

echo "ðŸ“„ Ð¤Ð°Ð¹Ð» /etc/netplan/01-netcfg.yaml ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½."
echo "ðŸ” Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° (600)."
echo "--------------------------------------------------------"
cat /etc/netplan/01-netcfg.yaml
echo "--------------------------------------------------------"

# --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ ---
echo "âš™ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ 'netplan generate'..."
netplan generate

if [ $? -ne 0 ]; then
    echo "ðŸš« ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐµ. Ð’Ñ‹Ñ…Ð¾Ð´."
    exit 1
fi

echo "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð²ÐµÑ€Ð½Ñ‹Ð¹."
echo "â³ Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° 'netplan try' Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ."
sleep 2

netplan try

echo "--------------------------------------------------------"
read -p "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð´Ð»Ñ Ð²Ñ‹Ñ…Ð¾Ð´Ð°."

exit 0
