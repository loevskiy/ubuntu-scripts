#!/bin/bash

# ==============================================================================
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÐµÑ‚Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Netplan Ð² Ubuntu (v3)
# - Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ 'routes' Ð²Ð¼ÐµÑÑ‚Ð¾ 'gateway4'
# - Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° 600 Ð½Ð° Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
# ==============================================================================

# --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· pipe
if ! [ -t 0 ]; then
    echo "ðŸš« ÐžÑˆÐ¸Ð±ÐºÐ°: Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼ Ð¸ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· pipe."
    echo "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: sudo bash -c \"\$(curl -sSL [URL])\""
    exit 1
fi

# --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
if [[ $EUID -ne 0 ]]; then
   echo "ðŸš« ÐžÑˆÐ¸Ð±ÐºÐ°: Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ ÑÑƒÐ¿ÐµÑ€Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (sudo)."
   exit 1
fi

# --- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
validate_ip_cidr() {
    local ip=$1
    local regex="^([0-9]{1,3}\.){3}[0-9]{1,3}\/[0-9]{1,2}$"
    if [[ $ip =~ $regex ]]; then return 0; else return 1; fi
}

validate_ipv6_cidr() {
    local ip=$1
    if [[ "$ip" == *"/"* && "$ip" == *":"* ]]; then return 0; else return 1; fi
}

clear
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ ÑÐµÑ‚Ð¸ Netplan (ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ 2024+)..."
echo "--------------------------------------------------------"

# --- Ð‘Ð»Ð¾Ðº Ð²Ð²Ð¾Ð´Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
while true; do
    read -p "1ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ IPv4 Ð°Ð´Ñ€ÐµÑ Ð´Ð»Ñ ens3 (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: ÐÐ”Ð Ð•Ð¡/ÐœÐÐ¡ÐšÐ): " ipv4_ens3
    if validate_ip_cidr "$ipv4_ens3"; then break; else echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚."; fi
done

ip_part=$(echo $ipv4_ens3 | cut -d'/' -f1)
suggested_gateway=$(echo $ip_part | awk -F. '{print $1"."$2"."$3".1"}')

read -p "2ï¸âƒ£  ÐŸÑ€ÐµÐ´Ð»Ð°Ð³Ð°ÐµÐ¼Ñ‹Ð¹ IPv4 ÑˆÐ»ÑŽÐ·: $suggested_gateway. Enter Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¸Ð»Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¹: " gateway4
if [ -z "$gateway4" ]; then gateway4=$suggested_gateway; fi

read -p "3ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ IPv6 Ð°Ð´Ñ€ÐµÑ Ð´Ð»Ñ ens3 (Ð¸Ð»Ð¸ Enter, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ): " ipv6_ens3
if [ -n "$ipv6_ens3" ]; then
    while ! validate_ipv6_cidr "$ipv6_ens3"; do
        echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ IPv6."
        read -p "3ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ IPv6 Ð°Ð´Ñ€ÐµÑ Ð´Ð»Ñ ens3 (Ð¸Ð»Ð¸ Enter, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ): " ipv6_ens3
        [ -z "$ipv6_ens3" ] && break
    done
fi
# Ð”Ð»Ñ IPv6 ÑˆÐ»ÑŽÐ· Ð¿Ð¾Ñ‡Ñ‚Ð¸ Ð²ÑÐµÐ³Ð´Ð° link-local fe80::1
gateway6="fe80::1"

while true; do
    read -p "4ï¸âƒ£  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ IP Ð°Ð´Ñ€ÐµÑ Ð´Ð»Ñ ens6 (Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: ÐÐ”Ð Ð•Ð¡/ÐœÐÐ¡ÐšÐ): " ipv4_ens6
    if validate_ip_cidr "$ipv4_ens6"; then break; else echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚."; fi
done

echo "--------------------------------------------------------"
echo "âœ… Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ñ‹. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð» ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."

# --- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Netplan Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ¾Ð¼
cat > /etc/netplan/01-netcfg.yaml << EOF
# Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» Ð±Ñ‹Ð» ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
network:
  version: 2
  renderer: networkd
  ethernets:
    ens3:
      addresses:
        - "$ipv4_ens3"
$( [ -n "$ipv6_ens3" ] && echo "        - \"$ipv6_ens3\"" )
      routes:
        - to: default
          via: $gateway4
$( [ -n "$ipv6_ens3" ] && echo "        - to: default
          via: $gateway6" )
      nameservers:
          addresses:
              - "8.8.8.8"
              - "1.1.1.1"
              - "8.8.4.4"
              - "1.0.0.1"
              - "2001:4860:4860::8888"
              - "2001:4860:4860::8844"
              - "2606:4700:4700::1111"
              - "2606:4700:4700::1001"

    ens6:
      addresses:
        - "$ipv4_ens6"
EOF

# --- Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° ---
chmod 600 /etc/netplan/01-netcfg.yaml

echo "ðŸ“„ Ð¤Ð°Ð¹Ð» /etc/netplan/01-netcfg.yaml ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½."
echo "ðŸ” Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° (600)."
echo "--------------------------------------------------------"

# --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
echo "âš™ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹ 'netplan generate'..."
netplan generate

if [ $? -ne 0 ]; then
    echo "ðŸš« ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐµ. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð²Ð²ÐµÐ´ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸ Ñ„Ð°Ð¹Ð»."
    exit 1
fi

echo "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ Ð²ÐµÑ€Ð½Ñ‹Ð¹. ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð¸ÑÑ‡ÐµÐ·Ð½ÑƒÑ‚ÑŒ."
echo "â³ Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° 'netplan try' Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ."
sleep 2

netplan try

echo "--------------------------------------------------------"
read -p "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter Ð´Ð»Ñ Ð²Ñ‹Ñ…Ð¾Ð´Ð°."

exit 0
